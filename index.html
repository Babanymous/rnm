<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Citadel of Ricks - Inspector</title>
    <style>
        :root {
            --portal-green: #00ff00;
            --dark-metal: #1a1a1a;
            --ui-glow: 0 0 15px rgba(0, 255, 0, 0.5);
        }

        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Courier New', Courier, monospace; }
        
        /* Стилизация интерфейса под компьютер Рика */
        #ui-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            color: var(--portal-green);
            text-shadow: var(--ui-glow);
            pointer-events: none;
            border-left: 3px solid var(--portal-green);
            padding-left: 15px;
        }

        #fact-card {
            position: absolute;
            right: 20px;
            top: 20px;
            width: 300px;
            background: rgba(0, 20, 0, 0.9);
            border: 1px solid var(--portal-green);
            box-shadow: var(--ui-glow);
            padding: 20px;
            color: #fff;
            display: none;
            clip-path: polygon(0% 0%, 100% 0%, 100% 90%, 90% 100%, 0% 100%);
        }

        .btn-reset {
            pointer-events: all;
            background: var(--portal-green);
            color: #000;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
        }

        .btn-reset:hover { background: #fff; }

        #loading {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: var(--portal-green); font-size: 20px;
        }
    </style>
</head>
<body>

    <div id="loading">Инициализация Цитадели...</div>

    <div id="ui-overlay">
        <h1>CITADEL_OS v.1.37</h1>
        <p>СТАТУС: ОНЛАЙН</p>
        <p>ОБЪЕКТ: ЦИТАДЕЛЬ РИКОВ</p>
        <button class="btn-reset" onclick="resetCamera()">СБРОС КАМЕРЫ</button>
    </div>

    <div id="fact-card">
        <h2 id="part-name" style="color: var(--portal-green);">СЕКТОР</h2>
        <hr style="border: 0.5px solid var(--portal-green);">
        <p id="part-desc"></p>
        <p style="font-size: 0.8em; color: #888;">[НАЖМИТЕ НА ПУСТОЕ МЕСТО, ЧТОБЫ ВЫЙТИ]</p>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        let scene, camera, renderer, controls, citadel;
        const pointer = new THREE.Vector2();
        const raycaster = new THREE.Raycaster();

        const data = [
            { name: "Главная Башня Совета", pos: [0, 6, 0], info: "Здесь заседает Совет Риков. Внутри находится самая охраняемая тюрьма и зал суда.", color: 0x00ff00 },
            { name: "Жилой Сектор (Мортиград)", pos: [5, -2, 3], info: "Трущобы, где живут Морти, потерявшие своих Риков. Здесь процветает торговля нелегальными семенами.", color: 0xaaaaaa },
            { name: "Научные Лаборатории", pos: [-6, 1, -2], info: "Место производства портальной жидкости и разработки сывороток для мутаций.", color: 0x0088ff },
            { name: "Доки и Порты", pos: [4, 2, -5], info: "Сюда прибывают корабли со всех уголков Вселенной. Контролируется таможней Риков.", color: 0xffcc00 },
            { name: "Энергоблок 'Микровселенная'", pos: [-3, -4, 4], info: "Весь город питается от рабского труда целой цивилизации, живущей в маленькой коробке.", color: 0xff00ff }
        ];

        init();
        animate();

        function init() {
            // Базовая сцена
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.02);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(15, 10, 20);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            // Освещение
            const light = new THREE.PointLight(0x00ff00, 100, 50);
            light.position.set(5, 5, 5);
            scene.add(light);
            scene.add(new THREE.AmbientLight(0x444444));

            // Контроллер
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            // Группа Цитадели
            citadel = new THREE.Group();
            
            // 1. Центральное тело (сложная форма)
            const coreGeo = new THREE.IcosahedronGeometry(3, 1);
            const coreMat = new THREE.MeshPhongMaterial({ color: 0x333333, flatShading: true });
            const core = new THREE.Mesh(coreGeo, coreMat);
            citadel.add(core);

            // 2. Кольцо портальной энергии
            const ringGeo = new THREE.TorusGeometry(8, 0.05, 16, 100);
            const ringMat = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
            const ring = new THREE.Mesh(ringGeo, ringMat);
            ring.rotation.x = Math.PI / 2;
            citadel.add(ring);

            // 3. Создание инспекционных точек
            data.forEach((d) => {
                const group = new THREE.Group();
                group.position.set(...d.pos);

                // Сама башня/сектор
                const towerGeo = new THREE.ConeGeometry(0.8, 4, 6);
                const towerMat = new THREE.MeshPhongMaterial({ color: d.color });
                const tower = new THREE.Mesh(towerGeo, towerMat);
                tower.userData = d; // Сохраняем данные
                
                // Эффект свечения у основания
                const glowGeo = new THREE.SphereGeometry(1, 16, 16);
                const glowMat = new THREE.MeshBasicMaterial({ color: d.color, transparent: true, opacity: 0.2 });
                const glow = new THREE.Mesh(glowGeo, glowMat);
                
                group.add(tower);
                group.add(glow);
                citadel.add(group);
            });

            // 4. Мелкие детали (мусор в космосе)
            for(let i=0; i<40; i++) {
                const bitGeo = new THREE.BoxGeometry(0.2, 0.2, 0.2);
                const bit = new THREE.Mesh(bitGeo, coreMat);
                bit.position.set(
                    (Math.random()-0.5)*15,
                    (Math.random()-0.5)*15,
                    (Math.random()-0.5)*15
                );
                citadel.add(bit);
            }

            scene.add(citadel);

            // Звезды
            const starsGeo = new THREE.BufferGeometry();
            const starsPos = [];
            for(let i=0; i<2000; i++) starsPos.push((Math.random()-0.5)*500, (Math.random()-0.5)*500, (Math.random()-0.5)*500);
            starsGeo.setAttribute('position', new THREE.Float32BufferAttribute(starsPos, 3));
            scene.add(new THREE.Points(starsGeo, new THREE.PointsMaterial({color: 0xffffff, size: 0.5})));

            document.getElementById('loading').style.display = 'none';

            window.addEventListener('click', onMouseClick);
            window.addEventListener('resize', onWindowResize);
        }

        function onMouseClick(event) {
            pointer.x = (event.clientX / window.innerWidth) * 2 - 1;
            pointer.y = - (event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(pointer, camera);
            const intersects = raycaster.intersectObjects(citadel.children, true);

            if (intersects.length > 0) {
                const object = intersects[0].object;
                if (object.userData.name) {
                    showFact(object.userData, intersects[0].point);
                }
            } else {
                hideFact();
            }
        }

        function showFact(info, lookAtPos) {
            const card = document.getElementById('fact-card');
            document.getElementById('part-name').innerText = info.name;
            document.getElementById('part-desc').innerText = info.info;
            card.style.display = 'block';

            // Анимация камеры к объекту
            const offset = new THREE.Vector3().subVectors(camera.position, lookAtPos).normalize().multiplyScalar(8);
            const targetPos = new THREE.Vector3().addVectors(lookAtPos, offset);
            
            // Простой "плавный" переход через библиотеку не будем тянуть, сделаем через Lerp в animate
            cameraTarget = targetPos;
            controls.target.copy(lookAtPos);
        }

        let cameraTarget = null;

        function hideFact() {
            document.getElementById('fact-card').style.display = 'none';
        }

        window.resetCamera = function() {
            cameraTarget = new THREE.Vector3(15, 10, 20);
            controls.target.set(0,0,0);
            hideFact();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            citadel.rotation.y += 0.001;
            
            if (cameraTarget) {
                camera.position.lerp(cameraTarget, 0.05);
                if (camera.position.distanceTo(cameraTarget) < 0.1) cameraTarget = null;
            }

            controls.update();
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>

